#!/bin/bash
set -eux

CELLTYPE=$1
BAM=$2

# Path to the flattened GFF generated by aggregate of the gff files created by each gene separately
FLATTENED_GFF=$HOME"/GrASE_simulation/ref/gencode.v28.dexseq.bygene.gff"

# Path to BAM files
BAM_DIR=$HOME"/GrASE_simulation/STAR/"$CELLTYPE"/bam"

# Output directory for count files
OUT_DIR=$HOME"/GrASE_simulation/DEXSeq/count_files/"$CELLTYPE

# Path to dexseq_count.py
DEXSEQ_SCRIPT=$HOME"/GrASE/scripts/dexseq_count.py"

# Paired-end? (yes or no)
PAIRED="yes"

# Stranded? Options: yes, no, reverse
STRANDED="reverse"

# Format: bam or sam
FORMAT="bam"

# BAM sorting order: name or pos
ORDER="pos"

# ==========================

mkdir -p "$OUT_DIR"

BASENAME=$(basename "$BAM" .Aligned.sortedByCoord.out.bam)
BASENAME="${BASENAME#'pass2_'}"
OUTFILE="$OUT_DIR/${BASENAME}_counts.txt"

samtools index $BAM 

python3 "$DEXSEQ_SCRIPT" \
    --format "$FORMAT" \
    --stranded "$STRANDED" \
    --order "$ORDER" \
    --paired "$PAIRED" \
    "$FLATTENED_GFF" \
    "$BAM" \
    "$OUTFILE"

# Remove summary lines (starting with _) and quotes from the output
grep -v "^_" "$OUTFILE" | sed 's/"//g' > "$OUTFILE.tmp" && mv "$OUTFILE.tmp" "$OUTFILE"



